
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="utf-8">
	<script>window.prettyPrint=function(){};</script>
<title>How Bad is DOM Interaction - Really?</title>
<meta name="description" content="How Bad is DOM Interaction - Really?">
	<link rel="stylesheet" href="assets/css/m.min.css">
	<link rel="shortcut icon" href="/favicon.ico" />
	<meta name="author" content="Andy Shora">
	<link rel="author" href="https://plus.google.com/115209922186713310205/posts"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<meta property="og:site_name" content="andyshora.com"/>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script>
/* Modernizr 2.7.1 (Custom Build) | MIT & BSD
 * Build: http://modernizr.com/download/#-cssanimations-touch-teststyles-testprop-testallprops-prefixes-domprefixes-load
 */
;window.Modernizr=function(a,b,c){function y(a){i.cssText=a}function z(a,b){return y(l.join(a+";")+(b||""))}function A(a,b){return typeof a===b}function B(a,b){return!!~(""+a).indexOf(b)}function C(a,b){for(var d in a){var e=a[d];if(!B(e,"-")&&i[e]!==c)return b=="pfx"?e:!0}return!1}function D(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:A(f,"function")?f.bind(d||b):f}return!1}function E(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+n.join(d+" ")+d).split(" ");return A(b,"string")||A(b,"undefined")?C(e,b):(e=(a+" "+o.join(d+" ")+d).split(" "),D(e,b,c))}var d="2.7.1",e={},f=b.documentElement,g="modernizr",h=b.createElement(g),i=h.style,j,k={}.toString,l=" -webkit- -moz- -o- -ms- ".split(" "),m="Webkit Moz O ms",n=m.split(" "),o=m.toLowerCase().split(" "),p={},q={},r={},s=[],t=s.slice,u,v=function(a,c,d,e){var h,i,j,k,l=b.createElement("div"),m=b.body,n=m||b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:g+(d+1),l.appendChild(j);return h=["&#173;",'<style id="s',g,'">',a,"</style>"].join(""),l.id=g,(m?l:n).innerHTML+=h,n.appendChild(l),m||(n.style.background="",n.style.overflow="hidden",k=f.style.overflow,f.style.overflow="hidden",f.appendChild(n)),i=c(l,a),m?l.parentNode.removeChild(l):(n.parentNode.removeChild(n),f.style.overflow=k),!!i},w={}.hasOwnProperty,x;!A(w,"undefined")&&!A(w.call,"undefined")?x=function(a,b){return w.call(a,b)}:x=function(a,b){return b in a&&A(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=t.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(t.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(t.call(arguments)))};return e}),p.touch=function(){var c;return"ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch?c=!0:v(["@media (",l.join("touch-enabled),("),g,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(a){c=a.offsetTop===9}),c},p.cssanimations=function(){return E("animationName")};for(var F in p)x(p,F)&&(u=F.toLowerCase(),e[u]=p[F](),s.push((e[u]?"":"no-")+u));return e.addTest=function(a,b){if(typeof a=="object")for(var d in a)x(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,typeof enableClasses!="undefined"&&enableClasses&&(f.className+=" "+(b?"":"no-")+a),e[a]=b}return e},y(""),h=j=null,e._version=d,e._prefixes=l,e._domPrefixes=o,e._cssomPrefixes=n,e.testProp=function(a){return C([a])},e.testAllProps=E,e.testStyles=v,e}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};
	</script>


	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<!--[if lt IE 7 ]><script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
	<script>window.attachEvent("onload",function(){CFInstall.check({mode:"overlay"})});</script><![endif]-->

</head>
<body>

<div id="body_wrap">

	<header class="page-header">
		<div class="page-header__title">
			<h1>How Bad is DOM Interaction - Really?</h1>
			<p>A JavaScript performance investigation. By <a href="#author">Andy Shora</a></p>
			<a href="/">&larr; back to andyshora.com</a> | <a class="twitter-share-button-placeholder" data-via="andyshora">Tweet this article<i class="icon icon-twitter"></i></a>
		</div>
		<div class="header_twitter"><a href="http://twitter.com/andyshora" title="Follow me on Twitter @andyshora"></a></div>
	</header>

	<section>
		<p><strong>Lots of us frontend developers seem to be increasingly concerned with interacting with the DOM lately, during a time when JavaScript engines and browser rendering performance has been faster than ever!</strong></p>
		<p>In this article I will try to douse a few myths about DOM interaction in foam, whilst giving a few little performance tips to make sure your apps run super fast when you're interacting with the DOM.</p>
	</section>


	<section>
		<h2>Performance Question: Is DOM interaction expensive?</h2>
		<p><em>The short answer is, yes. The long answer is, expensive in relation to what exactly?</em></p>
	</section>
	<hr>
	<section>
		<h2>1. The Difference between DOM reading and writing</h2>
		<p><em>Do you want to extract some data from the DOM, or actually update things?</em></p>
		<p>As you probably guessed, writing to the DOM is more expensive. When the DOM is updated, the browser has to re-parse parts of the DOM, and re-render styles.</p>
		<p><strong>Performance Demo: Let's see the difference in speed...</strong></p>
		<div class="performance-test">
			<div id="test-box-1" class="test-box">Tests will read and write from this div</div>
			<button id="dom-test-1">Do some DOM reading and writing</button>
			<h3>Results will appear here...</h3>
			<p>Time for 10,000 reads: <strong id="read-result">-</strong><br>
			Time for 10,000 writes: <strong id="write-result">-</strong></p>
			<p id="ratio-result"></p>
		</div>
		<div class="takeaway-tip">Performance Tip: Reading from the DOM is inexpensive, but only write to the DOM when absolutely necessary!</div>
		<p><i>Note: reading certain properties from DOM elements are a lot slower than others. Here I'm showing a trivial example to show the order of the read/write difference relatively.</i></p>
	</section>

	<hr>
	<section>
		<h2>2. DOM interaction on resize</h2>
		<p><em>I felt you shudder for a moment. You anticipated the danger ahead - but is all as it seems?</em></p>
		<p>Firstly, we have to question how important is it to interact with the DOM on a window resize event? On desktop browsers, resize events will fire in the order of hundreds of times per second, so you'll have to question how critical is it to execute your DOM interaction logic on every single event. This introduces us to an important concept, <strong>debouncing events</strong>.</p>
		<p>
		<h3>How to debounce events:</h3>
		<a href="http://davidwalsh.name/function-debounce" target="_blank">How to implement debounced events with Underscore.js</a></p>
		<p>Debounced events are exactly the same as normal events, except you set how frequently an event should become 'debounced'. This allows us to execute some logic for maybe every 1 in 20 resize events. If a resize event is fired for an orientation change, the event will always be debounced, so you can be sure that mobile browsers won't miss anything.</p>
		<h3>What's a realistic use case for using debounced events?</h3>
		<p>Say I need to update the src of an image when the window is made larger, in order to serve a better quality image suited to the new wider viewport, I'm going to need to execute some JavaScript to measure the new fluid container's width, and request an image suited to the new size...</p>
		<p>If I'm on a desktop browser, and someone is dragging the window wider, there's potentially going to be hundreds of window resize events firing. However, its not critical that I execute this <i>requestNewImage()</i> function on every event. I just need to ensure it's fired maybe every 500ms. So, I'll debounce the resize event, and only call the function when the event is debounced.</p>
		<pre class="prettyprint lang-js">
// Underscore.js method, via David Walsh (link above)
var requestNewImage = _.debounce(function(e) {

	// lets assume I've already cached my image and imageContainer selectors, and I have a nice dynamic image resizing service
	var containerWidth = $imageContainer.width();
	var newImageSrc = 'http://myimageservice.com/my-image/w=' + containerWidth;
	$img.attr('src', newImageSrc);

}, 500); // maximum run of once per 500 milliseconds

// Add the event listener
window.addEventListener("resize", requestNewImage, false);

		</pre>

		<p>(Of course I was using a service like <a href="http://www.resrc.it/" target="_blank">ReSRC.it to serve responsive images</a> all this would be taken care of!)</p>

		<p>On mobile browsers, resize events will only fire when you change your device orientation, so this in itself handles a lot of performance problems for us. However, the JavaScript on your page shouldn't really know if it's executing in a mobile browser, so all you need to know is you can rest assured that mobile browsers won't miss out on any code execution due to the small number of resize events fired.</p>
		<p>I'm sticking my neck out here, but if your web page is purely for mobile browsers (such as in a web view in a native app), then it's ok to not debounce events such as resize, as they will only fire on orientation change.</p>
		<div class="takeaway-tip">Performance Tip: Debounce your resize events, and only perform DOM-intensive work when frequently fired events are debounced.</div>
	</section>
	<hr>
	<section>
		<h2>3. Caching jQuery selectors</h2>
		<p><em>Make use of caching parts of the DOM you will be interacting with often.</em></p>
		<p>Every time you specify a jQuery selector, say <span class="inline-code">$('.my-boxes')</span>, you're asking jQuery to search the entire DOM for all matches. For optimal performance, you should store the matches for this selector in a JavaScript variable, and reference them during interaction.</p>
		<h3>How to cache jQuery selectors...</h3>
		<pre class="prettyprint lang-js">// convention is to name your cached selector variable starting with a $
var $myBoxes;

$(document).ready(function() {

	// initialization
	$myBoxes = $('.my-boxes');

	// ...

	// retrieve some data
	var boxCount = $myBoxes.length;

	// do some updates later - remember its already a jQuery object
	$myBoxes.css('background-color', 'red');
});
</pre>
		<div class="performance-test">
			<div id="test-box-3" class="test-box test-box-3">Tests will read and write from this div</div>
			<button id="dom-test-3">Do some DOM reading</button>
			<h3>Results will appear here...</h3>
			<p>Time for 10,000 reads (searching entire DOM): <strong id="read-result-normal">-</strong><br>
			Time for 10,000 reads (cached selector): <strong id="read-result-cached">-</strong></p>
			<p id="ratio-result-3"></p>
		</div>

		<div class="takeaway-tip">Performance Tip: Cache jQuery selectors, so you don't have to search the entire DOM on every operation.</div>
	</section>
	<hr>
	<section>
		<h2>Followup Edits</h2>
		<p>To answer a few comments from around the interwebs...</p>
		<ul>
			<li>The benchmarks above are designed to show the relative difference between operations. Timers in JavaScript are inaccurate, so I've aimed to offset slight inconsistencies by setting a high number of operations to be performed in each test.</li>
			<li>Yes, some applications do have to do work on resize. Some examples: loading responsive images, performing some action when an element becomes visible in the viewport, adjusting virtual wrapper widths for elements requiring animation on touch events.</li>
			<li>I decided reflows and repaints were out of scope for this article. However, I have plans to cover this after an enlightening visit from the awesome <a href="https://twitter.com/jaffathecake" target="_blank">Jake Archibald</a>!</li>
		</ul>
	</section>
	<hr>
	<section>
		<h2>webPagePerformance++</h2>
		<p>Hopefully you're now armed with a few performance tweaks for your web apps. Thanks for reading, hit me up with any questions/comments regarding these topics below!</p>
	</section>
</div>
<script>
	$(document).ready(function() {
		$('#dom-test-1').click(function(){
			var t1;

			// we wont cache the selector, or reads will be so fast it will make the relative comparison pointless
			function readFromDiv() {
				var c = $('#test-box-1')[0].innerHTML;
			}

			function writeToDiv(str) {
				$('#test-box-1')[0].innerHTML = str;
			}

			// read test
			t1 = +new Date;
			for(var i=0; i<10000; i++) {
				var str = Math.random(); // make it fair
				readFromDiv();
			}
			t2 = +new Date;

			var tDiff1 = t2 - t1;
			$('#read-result').html(tDiff1 + 'ms');

			// write test
			t1 = +new Date;
			for(var i=0; i<10000; i++) {
				var str = Math.random();
				writeToDiv(str);
			}
			t2 = +new Date;

			var tDiff2 = t2 - t1;
			$('#write-result').html(tDiff2 + 'ms');

			// calc ratio
			var ratio = Math.round(tDiff2/tDiff1);
			$('#ratio-result').html('Wow, reading was about ' + ratio + ' times faster!');

		});

		$('#dom-test-3').click(function(){
			var t1;
			var $box = $('.test-box-3');

			function readFromDivCached() {
				var c = $box[0].innerHTML;
			}

			function readFromDiv() {
				var c = $('.test-box-3')[0].innerHTML;
			}

			// read test - normal
			t1 = +new Date;
			for(var i=0; i<10000; i++) {
				readFromDiv();
			}
			t2 = +new Date;

			var tDiff1 = t2 - t1;
			$('#read-result-normal').html(tDiff1 + 'ms');

			// read test - cached
			t1 = +new Date;
			for(var i=0; i<10000; i++) {
				readFromDivCached();
			}
			t2 = +new Date;

			var tDiff2 = t2 - t1;
			$('#read-result-cached').html(tDiff2 + 'ms');

			// calc ratio
			var ratio = Math.round(tDiff1/tDiff2);
			$('#ratio-result-3').html('Wow, caching a selector made the read ' + ratio + ' times faster!');

		});

		$('.twitter-share-button-placeholder').bind('mouseover', function() {
			enableShareButton($(this));
		});


		prettyPrint();

		enableShareButton($('.twitter-share-button-placeholder'));

		window._gaq = [['_setAccount','UA-17716290-10'],['_trackPageview'],['_trackPageLoadTime']];
		Modernizr.load({
		load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
		});

		prettyPrint();


	});

	function enableShareButton(elm) {

		elm.addClass('twitter-share-button')
			.removeClass('twitter-share-button-placeholder')
			.attr('href', 'https://twitter.com/share')
			.unbind('click');

		!function(d,s,id){
			var js,
			fjs=d.getElementsByTagName(s)[0],
			p=/^http:/.test(d.location)?'http':'https';

			if(!d.getElementById(id)){
				js=d.createElement(s);
				js.id=id;
				js.src=p+'://platform.twitter.com/widgets.js';
				fjs.parentNode.insertBefore(js,fjs);
			}
		}(document, 'script', 'twitter-wjs');

	}
	function revealEmail() {
		alert('andyshora' + '@gmail.com');
	}
</script>
<div class="author-wrap" id="author">
	<section class="author">
		<div class="author__pic"></div>
		<div class="author__desc">
			<p>Hi, I'm <strong>Andy Shora</strong>. I'm a <strong>Frontend Web Developer</strong> based in London and I currently work with some very talented people over at <a href="http://www.rga.com">R/GA</a>. I founded <a href="http://www.stackey.com" target="_blank" title="Stackey.com, a place where you can stack things that go together">Stackey.com</a> - a place to stack things. All work here is my own.</p>
			<div class="author__links">
				<a class="author__link" href="http://twitter.com/andyshora"><i class="icon-twitter"></i> andyshora</a>
				<a class="author__link" href="http://www.facebook.com/andyshora"><i class="icon-facebook"></i> fb<span class="link__extra">.com/andyshora</span></a>
				<a class="author__link" href="http://www.pinterest.com/andyshora"><i class="icon-pinterest"></i> pinterest<span class="link__extra">.com/andyshora</span></a>
				<a class="author__link" href="http://www.github.com/andyshora"><i class="icon-github"></i> github<span class="link__extra">.com/andyshora</span></a>
				<a class="author__link" onclick="revealEmail()"><i class="icon-envelope"></i> contact<span class="link__extra"> me</span></a>
			</div>
		</div>
	</section>
</div>
<section class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'andyshora'; // required: replace example with your forum shortname
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			if ((window.location+'').match(/dev\./g)) return;
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>
<!-- footer -->
<footer>
	<p>Andy Shora &copy; 2014</p>
</footer>
<!-- end footer -->
<script type="text/javascript" src="assets/js/prettify.js"></script>
<script type="text/javascript">

	$(document).ready(function() {
		// tracking
		window._gaq = [['_setAccount','UA-17716290-10'],['_trackPageview'],['_trackPageLoadTime']];
		Modernizr.load({
		  load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
		});

		prettyPrint();
	});

</script>
</body>
</html>
